---
title: "Using Survey Data"
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
```

This article aims to guide you through the process of uploading, processing, and exploring survey data.

```{r setup, include = FALSE}
library(scgUtils)
```
<br>

### Step 1: Upload
##### **Using data from packages**

If you are using the sample dataset within this package, use the following:
```{r upload_data}
df <- get_data("survey")
```
<br>

##### **Using other data**

Alternatively, if you are uploading your own data, you can use the [`haven`](https://haven.tidyverse.org/) package to read an SPSS file in R.

```{r upload_data_alternative, eval = FALSE}
df <- haven::read_sav("your_survey_data.sav")
```

*Troubleshooting `read_sav()`:*

NB if an error occurs which relates to encoding, try adding `encoding="latin1"`. Once you have uploaded the data, view which string is causing the error. This may have been caused by `NAs` which will require you to convert them from a string to `NA`. For example:
```{r upload_data_troubleshooting, eval = FALSE}
df <- haven::read_sav("your_survey_data.sav", encoding="latin1")

# Additional step to amend error across entire dataset (all columns)
df[df == "__NA__"] <- NA
```
<br>

### Step 2: View
View the first 6 rows of the data file and the details of each column
```{r view_data2, eval = FALSE}
# NB first 3 variables shown only
head(df[,1:3])
# A tibble: 6 x 3
#      id    wt turnoutUKGeneral
#   <dbl> <dbl> <dbl+lbl>
# 1     7 0.376 5 [Very likely that I would vote]
# 2    14 0.553 5 [Very likely that I would vote]
# 3    15 0.712 5 [Very likely that I would vote]
# 4    18 0.440 4 [Fairly likely]
# 5    19 0.361 5 [Very likely that I would vote]
# 6    24 1.69  5 [Very likely that I would vote]
```
<br>

You can also view the original questionnaire and values easily by using the [`sjPlot`](https://strengejacke.github.io/sjPlot/) package.
```{r view_data1, eval = FALSE}
# NB first 10 variables shown only
sjPlot::view_df(df[,1:10])
```
````{=html}
<iframe width="100%" height="850"
  src="img/questionnaire.html"
  frameborder="0"
  allowfullscreen></iframe>
````
<br>

### Step 3: Clean
##### **Converting labelled data into factors**

To add remove the labels from the variables and convert them into factors, use the [`labelled`](https://larmarange.github.io/labelled/) package.
```{r clean_data1}
df <- labelled::unlabelled(df)
```
```{r clean_data2, eval = FALSE}
# NB first 3 variables shown only
head(df[,1:3])
# A tibble: 6 x 3
#      id    wt turnoutUKGeneral
#   <dbl> <dbl> <fct>
# 1     7 0.376 Very likely that I would vote
# 2    14 0.553 Very likely that I would vote
# 3    15 0.712 Very likely that I would vote
# 4    18 0.440 Fairly likely
# 5    19 0.361 Very likely that I would vote
# 6    24 1.69  Very likely that I would vote
```
<br>

##### **Removing unused factor levels**

Sometimes there will be circumstances where you have unused factor levels, such as "Under 18" (often occurs in surveys which disqualifies certain respondents from participating).
```{r clean_data3}
levels(df$ageGroup)
```

To remove all unused factor levels across the dataset, you can use the `remove_levels` function.
```{r clean_data4}
df <- remove_levels(df)
```

Using this function will ensure that the metadata is retained and can still be accessed.
```{r clean_data5}
# "Under 18" has not been removed:
levels(df$ageGroup)

# The metadata containing the question/label for this column remains:
attr(df$ageGroup, "label")
```
<br>

### Step 4: Weighting
*Section and functions to be added in the future*

<br>

### Step 5: Explore
##### **Numeric data**
To find the average of numeric data, use the `mean` or `weighted.mean` functions from the `stats` package (base R).
```{r numeric1}
# Unweighted:
mean(df$age)
```
```{r numeric2}
# Weighted:
weighted.mean(df$age, df$wt)
```
<br>

To find weighted or unweighted averages by one or many group variables, use the `grp_mean` function.
```{r numeric3}
# By a single group:
grp_mean(df,
         meanVar = "age",
         groups = "gender",
         weight = "wt" # optional
)
```
```{r numeric4}
# By many groups:
grp_mean(df,
         meanVar = "age",
         groups = c("gender", "partyId"),
         set_names = c("Gender", "Party Identification", "Average Age"), # change names
         round_decimals = 2 # round decimal places to 2 digits
)
```
<br>

### Step 6: Visualise
##### **Population structure**
To view the population profile of the respondents, use the `plot_popn` function. If no meanVar is provided, the graph will show just the Male and Female titles without the average age provided.
```{r popn_plot}
plot_popn(data=df,
          xVar="gender",
          yVar="ageGroup",
          weight="wt", # optional
          meanVar="age", # optional (must be numeric)
          addLabels = "yes" # to add % labels
)
```
<br>

The `plot_popn` function can also be facetted by a group. This will show each value of the selected group and overlay the results onto the total population population structure (in grey). The function will also automatically capture the metadata providing the question/label and provide this as the subtitle for ease of understanding.
```{r popn_plot2, fig.width=10, fig.height=6, dpi=300}
plot_popn(data=df,
          xVar="gender",
          yVar="ageGroup",
          group="turnoutUKGeneral",
          weight="wt", # optional
          addLabels = "yes" # to add % labels
)
```

##### **Individual crosstabs**
```{r crosstabInd, eval = FALSE}
crosstab(data=df,
         rowVar="gender",
         colVar="ageGroup",
         weight="wt", # optional
         totals=TRUE,
         statistics=TRUE,
         plot=TRUE
)
```
<br>
